Как это (вроде бы) работает:

![architecture](d1.png)

Красивая (и, скорее всего, не очень правильная) UML-диаграмма:

![moarchitecture](d2.png)
